let mysql = require('../modules/mysql');
let methods = require('../modules/methods');
let Container = require('../modules/data');
let chat = require('../modules/chat');

let vSync = require('./vSync');

let user = require('../user');
let weather = require('./weather');

let vehicles = require('../property/vehicles');

let copsRacer = exports;

let spawnStreet = [
    [-475.1373291015625, -668.320556640625, 31.760711669921875, 270.3457336425781],
    [-198.03004455566406, -530.6561279296875, 33.8938102722168, 339.7673645019531],
    [-245.72279357910156, -373.7410888671875, 29.142663955688477, 28.051910400390625],
    [-354.5301818847656, -274.780029296875, 32.37224197387695, 51.468658447265625],
    [-496.69439697265625, -256.5141906738281, 34.89943313598633, 112.87432861328125],
    [-543.3385620117188, -333.67279052734375, 34.35240173339844, 202.03367614746094],
    [-449.44061279296875, -392.3114929199219, 32.63031005859375, 263.6866760253906],
];
let spawnCops = [
    [174.57974243164062, -709.8543090820312, 32.73686599731445, 70.16839599609375],
    [175.271240234375, -706.6795654296875, 32.73097610473633, 73.25631713867188],
    [178.90414428710938, -698.937744140625, 32.734413146972656, 71.36041259765625],
    [179.9755859375, -695.1680297851562, 32.73283004760742, 75.58416748046875],
    [176.52780151367188, -688.512451171875, 32.72435760498047, 167.34942626953125],
    [172.79653930664062, -687.9402465820312, 32.73258972167969, 165.4556884765625],
    [169.56845092773438, -685.69921875, 32.7257194519043, 165.57135009765625],
    [163.64328002929688, -683.612060546875, 32.729881286621094, 164.6514892578125],
    [160.23028564453125, -683.0769653320312, 32.72836685180664, 160.70294189453125],
    [156.4947509765625, -681.4258422851562, 32.728031158447266, 160.68792724609375],
    [149.96206665039062, -683.9332275390625, 32.733333587646484, 246.6000518798828],
    [147.8778076171875, -687.3140869140625, 32.73496627807617, 252.0604248046875],
    [145.8652801513672, -695.311279296875, 32.73588562011719, 245.11688232421875],
    [143.6781463623047, -698.4750366210938, 32.7341194152832, 244.8755340576172],
    [133.6357879638672, -704.27392578125, 32.731746673583984, 157.36944580078125],
    [130.21115112304688, -702.3922729492188, 32.719112396240234, 161.1788330078125],
    [126.51497650146484, -700.545166015625, 32.71546173095703, 158.45697021484375],
    [122.57930755615234, -700.087890625, 32.71839904785156, 163.11370849609375],
    [118.94953155517578, -698.2243041992188, 32.71321487426758, 161.1317138671875],
    [115.21400451660156, -696.629638671875, 32.710994720458984, 160.88153076171875],
    [111.25645446777344, -696.0601196289062, 32.720245361328125, 160.84234619140625],
    [107.42781066894531, -694.229248046875, 32.71847915649414, 162.941162109375],
    [103.78376007080078, -692.8795776367188, 32.72196578979492, 167.28485107421875],
    [96.7818603515625, -708.8799438476562, 32.739498138427734, 259.64752197265625],
    [96.37245178222656, -712.3142700195312, 32.731075286865234, 247.85281372070312],
    [94.46080780029297, -716.4271850585938, 32.73844528198242, 253.7840118408203],
    [93.1744384765625, -720.0739135742188, 32.73746871948242, 250.59449768066406],
    [96.75135040283203, -727.59814453125, 32.73554992675781, 340.7314758300781],
    [100.70824432373047, -729.4533081054688, 32.73534393310547, 347.0557861328125],
    [103.7356185913086, -731.0814819335938, 32.734344482421875, 337.9991149902344],
    [107.92293548583984, -731.407958984375, 32.73603057861328, 342.29815673828125],
    [114.76100158691406, -734.75, 32.73373031616211, 335.2386474609375],
    [118.82845306396484, -735.7843017578125, 32.73085021972656, 343.2252197265625],
    [133.0644073486328, -741.47607421875, 32.7332649230957, 338.0298156738281],
    [136.8554229736328, -742.2337646484375, 32.73122024536133, 338.862548828125],
    [140.98770141601562, -743.9255981445312, 32.72980880737305, 341.11517333984375],
    [147.7418212890625, -746.4524536132812, 32.73735427856445, 342.3691101074219],
    [151.00457763671875, -747.622314453125, 32.730712890625, 338.203857421875],
    [154.8210906982422, -749.6284790039062, 32.73258590698242, 344.1470947265625],
    [162.09202575683594, -745.0892333984375, 32.734493255615234, 69.61380004882812],
    [162.6524658203125, -741.5318603515625, 32.73037338256836, 72.6119384765625],
    [164.5078582763672, -737.4127807617188, 32.737335205078125, 71.03659057617188],
    [166.53182983398438, -734.070068359375, 32.73849105834961, 69.5440673828125],
    [407.9661560058594, -984.08642578125, 28.87371826171875, 232.41818237304688],
    [408.4555358886719, -980.3287963867188, 28.87418556213379, 229.06768798828125],
    [413.5579833984375, -1029.943603515625, 28.95405387878418, 359.2615661621094],
    [417.1493225097656, -1028.192626953125, 28.772621154785156, 1.93133544921875],
    [421.6250305175781, -1027.886962890625, 28.694047927856445, 0.92071533203125],
    [425.3059387207031, -1027.8751220703125, 28.630380630493164, 2.5430908203125],
    [580.8927612304688, 38.77250671386719, 92.16475677490234, 262.6539611816406],
    [587.5310668945312, 37.71796798706055, 91.49340057373047, 259.1419677734375],
    [593.7348022460938, 36.230712890625, 90.87262725830078, 254.6581268310547],
    [599.4967041015625, 34.460716247558594, 90.28929138183594, 250.14772033691406],
    [606.4103393554688, 32.13175964355469, 89.5752182006836, 252.68946838378906],
    [612.088134765625, 30.25074577331543, 88.99185180664062, 249.16387939453125],
    [618.3132934570312, 28.12580680847168, 88.34761810302734, 251.76028442382812],
    [625.345947265625, 25.769023895263672, 87.62189483642578, 251.3934783935547],
    [534.3499755859375, -41.57939529418945, 70.40560913085938, 214.02304077148438],
    [539.808837890625, -51.290897369384766, 70.57594299316406, 216.83106994628906],
    [545.8163452148438, -57.916378021240234, 70.66815185546875, 233.26649475097656],
    [557.4694213867188, -64.13302612304688, 70.52497863769531, 253.8860626220703],
    [822.5879516601562, -1258.09375, 25.85100555419922, 186.3468475341797],
    [827.816162109375, -1257.853759765625, 25.888641357421875, 186.0126953125],
    [833.1942138671875, -1257.941162109375, 25.927871704101562, 180.8306427001953],
    [855.519287109375, -1282.4810791015625, 26.12515640258789, 7.373504638671875],
    [838.733154296875, -1271.628662109375, 25.92160987854004, 4.0479736328125],
    [833.5219116210938, -1271.32861328125, 25.883085250854492, 4.54766845703125],
    [827.9876708984375, -1271.7469482421875, 25.868074417114258, 1.42828369140625],
    [822.9777221679688, -1272.120361328125, 25.848527908325195, 1.713226318359375],
    [808.6361083984375, -1306.036376953125, 25.72503662109375, 0.325775146484375],
    [808.7012939453125, -1297.9837646484375, 25.769399642944336, 359.47003173828125],
    [809.1541748046875, -1289.7760009765625, 25.790498733520508, 3.263153076171875],
    [809.349365234375, -1281.7750244140625, 25.832992553710938, 355.373779296875],
    [809.718017578125, -1274.451416015625, 25.85469627380371, 357.01849365234375],
    [843.9832153320312, -1352.5762939453125, 25.689905166625977, 248.83493041992188],
    [844.2846069335938, -1346.8182373046875, 25.675899505615234, 248.84107971191406],
    [844.0565185546875, -1340.560546875, 25.671646118164062, 244.48330688476562],
    [844.1450805664062, -1334.954345703125, 25.708587646484375, 253.47776794433594],
    [865.59375, -1377.8043212890625, 25.72723960876465, 39.76751708984375],
    [862.6519775390625, -1382.7584228515625, 25.747262954711914, 36.911773681640625],
    [860.1473999023438, -1387.7401123046875, 25.75782012939453, 42.922088623046875],
    [857.6524658203125, -1393.2803955078125, 25.748315811157227, 28.79638671875],
    [854.8009643554688, -1399.345458984375, 25.736940383911133, 33.324676513671875],
    [851.6744384765625, -1403.88525390625, 25.727907180786133, 34.2525634765625],
    [833.269775390625, -1414.3505859375, 25.753337860107422, 328.6444396972656],
    [828.4505615234375, -1413.949951171875, 25.76468849182129, 329.1006164550781],
    [817.8594360351562, -1333.772216796875, 25.700366973876953, 185.3072052001953],
    [817.9741821289062, -1341.149658203125, 25.72918128967285, 177.0704345703125],
    [817.8631591796875, -1348.5238037109375, 25.7276611328125, 179.12744140625],
    [817.771484375, -1355.9398193359375, 25.7274112701416, 179.1094970703125],
    [817.678466796875, -1363.8797607421875, 25.7320556640625, 179.39373779296875],
    [827.1380004882812, -1350.9686279296875, 25.70638084411621, 70.18426513671875],
    [828.6923217773438, -1345.6085205078125, 25.695158004760742, 69.39950561523438],
    [828.34033203125, -1339.58447265625, 25.702014923095703, 66.803466796875],
    [827.2625122070312, -1333.316162109375, 25.718461990356445, 41.113525390625],
    [377.9614562988281, -1579.44287109375, 28.77311897277832, 230.73341369628906],
    [384.0266418457031, -1584.46044921875, 28.772674560546875, 230.1151123046875],
    [393.0033264160156, -1592.01708984375, 28.76873016357422, 229.1297607421875],
    [403.1271057128906, -1616.6868896484375, 28.896305084228516, 52.7523193359375],
    [401.3214111328125, -1619.455322265625, 28.895565032958984, 53.9742431640625],
    [399.1376647949219, -1621.5604248046875, 28.89569091796875, 49.317230224609375],
    [396.9969482421875, -1623.6883544921875, 28.896373748779297, 48.277618408203125],
    [395.20263671875, -1626.032958984375, 28.89667320251465, 48.516754150390625],
    [384.689697265625, -1634.7135009765625, 28.89373207092285, 319.8563232421875],
    [387.76763916015625, -1636.7598876953125, 28.89289665222168, 321.411865234375],
    [342.04107666015625, -1633.0196533203125, 23.390762329101562, 228.5461883544922],
    [343.8652038574219, -1630.5528564453125, 23.382667541503906, 229.87213134765625],
    [345.8851013183594, -1628.079833984375, 23.389936447143555, 226.70606994628906],
    [345.47076416015625, -1640.69482421875, 23.3924503326416, 251.22946166992188],
    [-1072.4891357421875, -790.8450927734375, 18.86091423034668, 228.74293518066406],
    [-1063.45654296875, -797.5310668945312, 18.83475685119629, 237.02651977539062],
    [-1051.92578125, -803.70751953125, 18.15390396118164, 243.9590606689453],
    [-1037.42724609375, -808.7952880859375, 17.0234317779541, 252.02548217773438],
    [-1108.0648193359375, -800.1700439453125, 17.639734268188477, 246.01634216308594],
    [-1110.3990478515625, -802.1708984375, 17.38349151611328, 244.34063720703125],
    [-1113.219482421875, -804.671142578125, 17.056968688964844, 241.78244018554688],
    [-1116.105224609375, -806.7064819335938, 16.77470588684082, 242.22479248046875],
    [-1118.8355712890625, -809.1576538085938, 16.46870994567871, 236.04498291015625],
    [-1121.4068603515625, -811.2879028320312, 16.20366859436035, 238.8839111328125],
    [-1123.8309326171875, -813.618408203125, 15.92978572845459, 243.78085327148438],
    [-547.9786987304688, -142.1184844970703, 37.909568786621094, 65.17678833007812],
    [-552.2650756835938, -143.3474578857422, 37.8299560546875, 70.91085815429688],
    [-556.4046630859375, -144.9757080078125, 37.791473388671875, 62.891326904296875],
    [-560.1926879882812, -146.93824768066406, 37.71529006958008, 63.625640869140625],
    [-579.0302734375, -141.55397033691406, 36.38720703125, 201.49546813964844],
    [-584.7627563476562, -157.32569885253906, 37.499725341796875, 112.2396240234375],
    [-580.57421875, -170.92062377929688, 37.467689514160156, 290.6197814941406],
    [-574.5185546875, -168.77825927734375, 37.56473159790039, 293.7888488769531],
    [-568.3547973632812, -166.20692443847656, 37.64410400390625, 292.7704162597656],
    [-558.439453125, -162.306884765625, 37.770469665527344, 289.580322265625],
    [-550.4244384765625, -159.0045623779297, 37.83985137939453, 290.64141845703125],
];

let carListRacer = ['Elegy', 'Penumbra2', 'Jester3', 'Sultan2', 'Sultanrs', 'Banshee2'];
let carListCop = ['Police', 'Police2', 'Police4', 'Sheriff', 'FBI'];

let timer = 0;
let countLobby = 0;
let timerTake = 5;

copsRacer.loadAll = function() {
    methods.debug('copsRacer.loadAll');
    copsRacer.timer();
};

copsRacer.timer = function() {
    countLobby = 0;

    mp.players.forEachInDimension(99998, p => {
        if (!user.isLogin(p))
            return;
        if (p.vehicle)
            countLobby++;
    });

    let vPos = new mp.Vector3(0,0,0);
    mp.vehicles.forEachInDimension(99998, v => {
        if (v.getOccupants().length === 0)
            vehicles.respawn(v);
        else if (v.getVariable('crRole') === 1) {
            vPos = v.position;

            let velocity = veh.velocity;
            let speed = Math.sqrt(
                velocity.x * velocity.x +
                velocity.y * velocity.y +
                velocity.z * velocity.z
            );
            let speedMph = Math.round(speed * 2.23693629);

            if (speedMph < 5) {
                timerTake--;
            }
            else {
                timerTake = 5;
            }
        }
    });

    if (timer === 0 && countLobby > 3)
        timer = 600;
    else if (timer > 0) {
        timer--;
        if (timer === 0) {
            mp.players.forEachInDimension(99998, p => { //TODO RACER WIN

            });

            copsRacer.createNewLobby();
        }
    }

    if (countLobby <= 3)
        timer = 0;

    mp.players.forEachInDimension(99998, p => {
        if (!user.isLogin(p))
            return;

        if (p.vehicle) {
            user.createBlip(p, 99997, vPos.x, vPos.y, vPos.z, 523, 1);
            p.call('client:copsRacer:update', [timer, countLobby, timerTake]);
        }
        else
            copsRacer.playerToLobby(p);
    });

    setTimeout(copsRacer.timer, 1000);
};

copsRacer.createNewLobby = function() {
    timer = 600;

    mp.vehicles.forEachInDimension(99998, v => {
        vehicles.respawn(v);
    });

    let playerList = [];
    mp.players.forEachInDimension(99998, p => {
        if (!user.isLogin(p))
            return;
        playerList.push(p);
    });

    let roleRacer = playerList[methods.getRandomInt(0, playerList.length)];
    copsRacer.playerToLobby(roleRacer, 1);
    playerList.forEach(p => {
        if (roleRacer.id !== p.id)
            copsRacer.playerToLobby(p)
    })
};

copsRacer.playerToLobby = function(player, role = 0) {
    methods.debug('copsRacer.playerToLobby');
    if (user.isLogin(player)) {
        if (user.hasById(user.getId(player), 'uniform')) {
            player.notify('~r~В форме запрещено учавствовать в Cops & Racer');
            return;
        }

        user.blockKeys(player, true);
        user.unequipAllWeapons(player);

        player.dimension = 99998;
        player.setVariable('blockDeath', true);

        let spawnPos = spawnCops[methods.getRandomInt(0, spawnCops.length)];
        let currentVehicle = carListCop[methods.getRandomInt(0, carListCop.length)];

        if (countLobby === 0) {
            spawnPos = spawnStreet[methods.getRandomInt(0, spawnStreet.length)];
            currentVehicle = carListRacer[methods.getRandomInt(0, carListRacer.length)];
            role = 1;
        }

        user.set(player, 'crRole', role);

        countLobby++;

        player.outputChatBoxNew(`Кнопка !{2196F3}ESC!{FFFFFF} выйти из лобби`);
        player.notify(`Кнопка ~g~ESC~s~ выйти из лобби`);

        vehicles.spawnCarCb(veh => {

            if (!vehicles.exists(veh))
                return;

            try {
                veh.dimension = 99998;

                if (carListCop.includes(currentVehicle))
                    veh.setColor(111, 0);
                else {
                    let color = methods.getRandomInt(0,160);
                    veh.setColor(color, color);
                }

                player.call('client:copsRacer:update', [timer, countLobby, 5]);

                setTimeout(function () {
                    vSync.setEngineState(veh, true);
                    vSync.setAnchorState(veh, false);

                    if (currentVehicle === 'Police' || currentVehicle === 'Sheriff') {
                        vSync.setExtraState(veh, methods.getRandomInt(0, 3));
                    }
                    if (currentVehicle === 'Police2' || currentVehicle === 'Police3' || currentVehicle === 'Police4' || currentVehicle === 'Intcept' || currentVehicle === 'Intcept3') {
                        vSync.setExtraState(veh, methods.getRandomInt(0, 2));
                    }
                }, 1000);

                if (carListRacer.includes(currentVehicle)) {
                    veh.setVariable('crRole', 1);
                    setTimeout(function () {
                        player.call('client:copsRacer:tunning');
                    }, 1000)
                }
                else {
                    vSync.setSirenState(veh, 1);
                    veh.setVariable('crRole', 0);
                }
            }
            catch (e) {
                methods.debug(e);
            }

            if (user.isLogin(player))
                user.putInVehicle(player, veh, -1);

        }, new mp.Vector3(spawnPos[0], spawnPos[1], spawnPos[2]), spawnPos[3], currentVehicle);

    }
};

copsRacer.playerExitLobby = function(player) {
    methods.debug('gangZone.playerToLobby');
    if (user.isLogin(player)) {
        vehicles.respawn(player.vehicle);

        user.blockKeys(player, false);

        user.removeAllWeapons(player);
        player.dimension = 0;
        player.setVariable('blockDeath', undefined);

        user.setHealth(player, 100);
        player.spawn(new mp.Vector3(-253.9224, -1993.057, 30.14611));
        countLobby--;

        user.deleteBlip(player, 99997);
    }
};

mp.events.add("playerDeath", (player, reason, killer) => {

});